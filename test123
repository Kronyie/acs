--// Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Event = ReplicatedStorage:WaitForChild("Event")

--// Variables
local wandEnabled = false
local attackSpeed = 0.3
local attackRange = 100
local multiAttacks = 3
local lastAutoAttack = 0

-- Target mobs (lower priority = attacked first)
local targetMobs = {
    ["royalSpiderModel"] = 1,
    ["spiderModel"] = 2,
    ["crystalGuardianModel"] = 3,
    ["crystalArcherModel"] = 4,
    ["Sheds"] = 5,
    ["spiderDen8183Sheds"] = 6
}

-- Colors for status label
local mobColors = {
    ["royalSpiderModel"] = Color3.fromRGB(255, 0, 0),
    ["spiderModel"] = Color3.fromRGB(200, 100, 100),
    ["crystalGuardianModel"] = Color3.fromRGB(0, 255, 0),
    ["crystalArcherModel"] = Color3.fromRGB(0, 200, 200),
    ["Sheds"] = Color3.fromRGB(200, 200, 100),
    ["spiderDen8183Sheds"] = Color3.fromRGB(150, 50, 255)
}

-- Ignore list (your troops + bag)
local ignoreList = {"SwordTroop", "ArcherTroop", "WizardTroop", "Mystical Bag"}

--// GUI Setup
local ScreenGui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 250, 0, 180)
Frame.Position = UDim2.new(0, 20, 0.5, -90)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Frame.BorderSizePixel = 0

local ToggleButton = Instance.new("TextButton", Frame)
ToggleButton.Size = UDim2.new(1, -20, 0, 30)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.Text = "Toggle Wand: OFF"
ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

local SpeedBox = Instance.new("TextBox", Frame)
SpeedBox.Size = UDim2.new(1, -20, 0, 30)
SpeedBox.Position = UDim2.new(0, 10, 0, 50)
SpeedBox.PlaceholderText = "Attack Speed (0.1+)"
SpeedBox.Text = tostring(attackSpeed)

local RangeBox = Instance.new("TextBox", Frame)
RangeBox.Size = UDim2.new(1, -20, 0, 30)
RangeBox.Position = UDim2.new(0, 10, 0, 90)
RangeBox.PlaceholderText = "Attack Range"
RangeBox.Text = tostring(attackRange)

local StatusLabel = Instance.new("TextLabel", Frame)
StatusLabel.Size = UDim2.new(1, -20, 0, 20)
StatusLabel.Position = UDim2.new(0, 10, 0, 130)
StatusLabel.Text = "Target: None"
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)

local ExitButton = Instance.new("TextButton", Frame)
ExitButton.Size = UDim2.new(1, -20, 0, 25)
ExitButton.Position = UDim2.new(0, 10, 0, 155)
ExitButton.Text = "Exit Script"
ExitButton.BackgroundColor3 = Color3.fromRGB(100, 0, 0)

--// Button Logic
ToggleButton.MouseButton1Click:Connect(function()
    wandEnabled = not wandEnabled
    ToggleButton.Text = "Toggle Wand: " .. (wandEnabled and "ON" or "OFF")
    ToggleButton.BackgroundColor3 = wandEnabled and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(50, 50, 50)
end)

SpeedBox.FocusLost:Connect(function()
    local val = tonumber(SpeedBox.Text)
    if val and val >= 0.1 then
        attackSpeed = val
    end
end)

RangeBox.FocusLost:Connect(function()
    local val = tonumber(RangeBox.Text)
    if val and val > 0 then
        attackRange = val
    end
end)

ExitButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    script:Destroy()
end)

--// Attack Loop
task.spawn(function()
    while true do
        if wandEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local root = LocalPlayer.Character.HumanoidRootPart

            -- gather mobs
            local mobs = {}
            for _, obj in pairs(workspace:GetDescendants()) do
                if obj:IsA("Model") and obj:FindFirstChild("HumanoidRootPart") then
                    if targetMobs[obj.Name] then
                        -- ignore friendly stuff
                        local ignored = false
                        for _, ignore in ipairs(ignoreList) do
                            if string.find(obj.Name, ignore) then
                                ignored = true
                                break
                            end
                        end

                        if not ignored then
                            local dist = (obj.HumanoidRootPart.Position - root.Position).Magnitude
                            if dist < attackRange then
                                table.insert(mobs, {model = obj, priority = targetMobs[obj.Name], dist = dist})
                            end
                        end
                    end
                end
            end

            -- sort by priority then distance
            table.sort(mobs, function(a, b)
                if a.priority == b.priority then
                    return a.dist < b.dist
                else
                    return a.priority < b.priority
                end
            end)

            if #mobs > 0 then
                local topMob = mobs[1].model
                StatusLabel.Text = "Target: " .. topMob.Name
                StatusLabel.TextColor3 = mobColors[topMob.Name] or Color3.fromRGB(255, 255, 255)

                for _, mob in ipairs(mobs) do
                    for i = 1, multiAttacks do
                        Event:FireServer("use", "wand", "place", mob.model.HumanoidRootPart.Position)
                    end
                end
            else
                -- no mobs â†’ auto attack every 5s
                local now = tick()
                StatusLabel.Text = "Target: None"
                StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)

                if now - lastAutoAttack >= 5 then
                    lastAutoAttack = now
                    Event:FireServer("use", "wand", "place", root.Position + (root.CFrame.LookVector * 10))
                end
            end
        else
            StatusLabel.Text = "Target: None"
            StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
        end
        task.wait(attackSpeed)
    end
end)
