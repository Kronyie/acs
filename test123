--[[
  Refactored Multi-Bot (V53 - Procedural Executor Bypass)

  *** CRITICAL EXECUTION BYPASS ***
  - ARCHITECTURE SHIFT: Converted the complex Object-Oriented (OOP) structure (MultiGrinder:new) 
    into a flat, procedural script using local variables for state. This dramatically simplifies 
    the code structure to bypass common low-level "Line 1" execution errors.
    
  - All core functionality (Priority Zone TP, V52 Remote Fix, Auto-Ignore, SafetyNet) is retained.
--]]

-- [ 1. SERVICE AND GLOBAL SETUP ]
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players:WaitForChild("LocalPlayer", 10) 
if not LocalPlayer then return end

local Camera = Workspace:WaitForChild("CurrentCamera", 10)
if not Camera then return end


-- [ 2. STATE VARIABLES (FLAT ARCHITECTURE) ]
local _ENABLED = false
local _MODE = "Combat"
local _MAIN_GUI = nil
local _CURRENT_TAB = "General"
local _LOOP_THREAD = nil

-- Target State
local _CURRENT_TARGET_PART = nil            -- Part for Teleport (HRP or Resource Part)
local _CURRENT_TARGET_IDENTIFIER = nil      -- Top-Level Instance for Remote/Ignore (Model or Resource Part)
local _TARGET_ACQUIRED_TIME = nil

-- Config State
local _COMBAT_TOOL_NAME = "Unstable Cylindery Hammer"
local _COMBAT_TARGET_NAMES = "Musheynator, Mushmasher, Big Mushman, Mystic Mimic, Bluecapey, Cylindery"
local _MINING_TOOL_NAME = "Eternium Pickaxe"
local _MINING_TARGET_NAMES = "Iron, Rock, Blood Stone, Gold, Salt Rock"
local _PRIORITY_ZONES = {}
local _CURRENT_ZONE_INDEX = 1
local _IGNORED_TARGETS = setmetatable({}, {__mode = "k"})

-- Utility State
local _AUTO_IGNORE_ENABLED = true
local _SAFETY_NET_ENABLED = true
local _LAST_DEATH_CFRAME = nil
local _ORIGINAL_CAMERA_CFRAME = nil
local _UI_POSITION = UDim2.new(0.5, -130, 0.5, -195)
local _IS_MINIMIZED = false

-- Hardcoded Config (Kept outside state variables for stability)
local CONFIG = {
    FarmSpeed = 0.25, 
    PriorityZoneSearchRadius = 20, 
    PriorityZoneTeleportDelay = 0.5, 
    Combat = { TeleportOffset = Vector3.new(0, 5, 5) },
    Mining = { TeleportOffset = Vector3.new(0, 5, 2) },
    -- GUI Dimensions and Colors (same as V52)
    FrameWidth = 260, TitleBarHeight = 35, TabBarHeight = 30, ContentAreaHeight = 250, MainFrameCornerRadius = 10,
    ButtonHeight = 30, ButtonCornerRadius = 8, InputHeight = 30,
    BackgroundColor = Color3.fromRGB(35, 35, 45), TitleBarColor = Color3.fromRGB(30, 30, 40), TabBarColor = Color3.fromRGB(40, 40, 50), 
    AccentColor = Color3.fromRGB(0, 100, 200), ToggleOnColor = Color3.fromRGB(0, 180, 0), ToggleOffColor = Color3.fromRGB(180, 0, 0), 
    InputBackgroundColor = Color3.fromRGB(50, 50, 60), CloseButtonBaseColor = Color3.fromRGB(200, 0, 0), 
    CloseButtonHoverColor = Color3.fromRGB(220, 0, 0), MinimizeButtonBaseColor = Color3.fromRGB(90, 90, 110), 
    MinimizeButtonHoverColor = Color3.fromRGB(120, 120, 140), 
}
local INITIAL_FRAME_HEIGHT = CONFIG.TitleBarHeight + CONFIG.TabBarHeight + CONFIG.ContentAreaHeight

-- Remote Event Cache
local REMOTES = {}
local function getRemotes()
    local remotesContainer = Workspace:FindFirstChild("Remotes") or Workspace
    REMOTES.EquipItem = remotesContainer:WaitForChild("EquipItem", 5) 
    REMOTES.UseItem = remotesContainer:WaitForChild("UseItem", 5) 
    if not REMOTES.UseItem then warn("[Multi-Bot Debug] CRITICAL - UseItem remote not found.") end
end

-- [ 3. CORE HELPER FUNCTIONS ]

local function getHumanoidRootPart()
    local char = LocalPlayer.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function getTargetNames(mode)
    local targetString = (mode == "Combat") and _COMBAT_TARGET_NAMES or _MINING_TARGET_NAMES
    local names = {}
    for name in string.gmatch(targetString, "[^,]+") do
        names[#names + 1] = name:gsub("^%s*(.-)%s*$", "%1")
    end
    return names
end

local function isTargetValid(targetInstance)
    if not targetInstance or not targetInstance.Parent then
        return false
    end
    
    local humanoid = targetInstance:FindFirstChildOfClass("Humanoid")
    if targetInstance:IsA("Model") and humanoid then
        return humanoid.Health > 0
    end
    
    -- Check for valid resource part
    if targetInstance:IsA("BasePart") then
        local parentHumanoid = targetInstance.Parent:FindFirstChildOfClass("Humanoid")
        if parentHumanoid then
            return parentHumanoid.Health > 0
        end
        return true -- Assume resource part is valid if it's a part and not a mob part
    end
    
    return true
end

local function restoreCamera()
    if _ORIGINAL_CAMERA_CFRAME then 
        Camera.CFrame = _ORIGINAL_CAMERA_CFRAME 
        _ORIGINAL_CAMERA_CFRAME = nil 
    end
end

local function findLocalTarget(centerPos, radius, normalTargetNames, ignoredTargets)
    local closestTargetPart = nil
    local closestTargetKey = nil
    local minDist = math.huge
    local searchSpace = Workspace 

    for _, obj in ipairs(searchSpace:GetDescendants()) do
        local humanoid = obj:FindFirstChildOfClass("Humanoid")
        
        if humanoid and humanoid.Health > 0 and obj:FindFirstChild("HumanoidRootPart") then
            local targetPart = obj:FindFirstChild("HumanoidRootPart") 
            local targetKey = obj 
            
            if targetKey == Players.LocalPlayer.Character or ignoredTargets[targetKey] or not isTargetValid(targetKey) then continue end

            local distFromCenter = (targetPart.Position - centerPos).Magnitude
            
            if distFromCenter <= radius then
                local isTarget = false
                for _, name in ipairs(normalTargetNames) do
                    if string.lower(obj.Name) == string.lower(name) then
                        isTarget = true
                        break
                    end
                end
                
                if isTarget and distFromCenter < minDist then
                    minDist = distFromCenter
                    closestTargetPart = targetPart
                    closestTargetKey = targetKey
                end
            end
        end
    end

    return closestTargetPart, closestTargetKey
end

local function findBestCombatTarget(hrp, normalTargetNames)
    local playerPos = hrp.Position
    local closestTargetPart = nil 
    local closestTargetKey = nil 
    local minDistance = math.huge
    local searchSpace = Workspace 
    
    for _, obj in ipairs(searchSpace:GetDescendants()) do
        local humanoid = obj:FindFirstChildOfClass("Humanoid")
        
        -- Check for Combat Targets (Humanoids)
        if humanoid and humanoid.Health > 0 and obj:FindFirstChild("HumanoidRootPart") then
            local targetPart = obj:FindFirstChild("HumanoidRootPart")
            local targetKey = obj 
            
            if targetKey == LocalPlayer.Character or _IGNORED_TARGETS[targetKey] or not isTargetValid(targetKey) or not targetPart.Position then continue end
            
            local distFromPlayer = (targetPart.Position - playerPos).Magnitude
            
            local isNormal = false
            for _, name in ipairs(normalTargetNames) do
                if string.lower(obj.Name) == string.lower(name) then
                    isNormal = true
                    break
                end
            end
            
            if isNormal and distFromPlayer < minDistance then
                minDistance = distFromPlayer
                closestTargetPart = targetPart
                closestTargetKey = targetKey
            end
        
        -- Check for Mining Targets (Non-Humanoid Resources)
        elseif not humanoid and obj:IsA("BasePart") then
            local targetPart = obj 
            local targetKey = obj 

            if _IGNORED_TARGETS[targetKey] or not targetPart.Position then continue end
            
            local distFromPlayer = (targetPart.Position - playerPos).Magnitude

            local isMiningTarget = false
            for _, name in ipairs(normalTargetNames) do
                if string.lower(obj.Name) == string.lower(name) then
                    isMiningTarget = true
                    break
                end
            end

            if isMiningTarget and distFromPlayer < minDistance then
                minDistance = distFromPlayer
                closestTargetPart = targetPart
                closestTargetKey = targetKey
            end
        end
    end
    
    return closestTargetPart, closestTargetKey
end

-- V52: SIMULATE ACTION (Passes the top-level identifier to the remote)
local function simulateAction(toolName, targetRemoteInstance)
    local char = LocalPlayer.Character
    
    if not char or not REMOTES.UseItem then return end
    
    if not isTargetValid(targetRemoteInstance) then
        warn("[Multi-Bot Debug] V53 Atomic Check FAILED: Target Remote Instance is invalid right before remote fire.")
        _CURRENT_TARGET_PART = nil
        _CURRENT_TARGET_IDENTIFIER = nil
        restoreCamera()
        updateGUI()
        return 
    end

    local toolInstance = char:FindFirstChild(toolName) or LocalPlayer.Backpack:FindFirstChild(toolName)

    if toolInstance then
        REMOTES.UseItem:FireServer(toolInstance, targetRemoteInstance)
    else
        warn(string.format("[Multi-Bot Debug] CRITICAL FAILURE: Tool Instance (%s) not found.", toolName))
    end
end

-- [ 4. MAIN EXECUTION LOOPS ]

local function executeCombatAction(hrp)
    local toolName = _COMBAT_TOOL_NAME
    local targetNames = getTargetNames("Combat")
    local numZones = #_PRIORITY_ZONES

    -- 1. Check and Validate Current Target
    if not isTargetValid(_CURRENT_TARGET_IDENTIFIER) then 
        _CURRENT_TARGET_IDENTIFIER = nil 
        _CURRENT_TARGET_PART = nil 
    end
    
    if _CURRENT_TARGET_IDENTIFIER then
        goto AttackSequence
    end
    
    -- V47: NEW PRIORITY HUNT LOOP
    if numZones > 0 then
        local zoneFound = false
        
        if _CURRENT_ZONE_INDEX > numZones then
            _CURRENT_ZONE_INDEX = 1
        end

        local i = _CURRENT_ZONE_INDEX 
        local zonePos = _PRIORITY_ZONES[i]
        local targetPos = zonePos + Vector3.new(0, 5, 0) 
        
        hrp.CFrame = CFrame.new(targetPos) 
        
        task.wait(CONFIG.PriorityZoneTeleportDelay)
        
        local newTargetPart, newTargetKey = findLocalTarget(
            zonePos, 
            CONFIG.PriorityZoneSearchRadius, 
            targetNames, 
            _IGNORED_TARGETS
        )
        
        if newTargetPart then
            _CURRENT_TARGET_PART = newTargetPart 
            _CURRENT_TARGET_IDENTIFIER = newTargetKey 
            _TARGET_ACQUIRED_TIME = os.clock() 
            zoneFound = true
            updateGUI()
            goto AttackSequence 
        else
            _CURRENT_ZONE_INDEX = i + 1
        end
        
        if not zoneFound and _CURRENT_ZONE_INDEX ~= 1 then
            return false
        end
    end
    
    ::FallbackScan::
    -- 2. FALLBACK: FIND BEST TARGET (MAP-WIDE SEARCH)
    local newTargetPart, newTargetKey = findBestCombatTarget(hrp, targetNames)

    if newTargetPart then
        if _CURRENT_TARGET_IDENTIFIER ~= newTargetKey then
            _CURRENT_TARGET_PART = newTargetPart 
            _CURRENT_TARGET_IDENTIFIER = newTargetKey 
            _TARGET_ACQUIRED_TIME = os.clock() 
            updateGUI()
        end
    else
        if _CURRENT_TARGET_IDENTIFIER then
            _CURRENT_TARGET_PART = nil
            _CURRENT_TARGET_IDENTIFIER = nil
            _TARGET_ACQUIRED_TIME = nil
            restoreCamera()
            updateGUI()
        end
        return false 
    end

    -- 3. AUTO-IGNORE LOGIC
    ::AttackSequence::
    
    local targetPart = _CURRENT_TARGET_PART 
    local targetRemoteInstance = _CURRENT_TARGET_IDENTIFIER 

    if not isTargetValid(targetRemoteInstance) or not targetPart or not targetPart:IsA("BasePart") then
         _CURRENT_TARGET_PART = nil
         _CURRENT_TARGET_IDENTIFIER = nil
         return false
    end

    if _AUTO_IGNORE_ENABLED and _TARGET_ACQUIRED_TIME and (os.clock() - _TARGET_ACQUIRED_TIME > 10) then
        if isTargetValid(targetRemoteInstance) then
            _IGNORED_TARGETS[targetRemoteInstance] = true 
            _CURRENT_TARGET_PART = nil 
            _CURRENT_TARGET_IDENTIFIER = nil 
            _TARGET_ACQUIRED_TIME = nil
            restoreCamera()
            updateGUI()
            return false 
        else
            _TARGET_ACQUIRED_TIME = nil 
        end
    end

    -- 4. EQUIP TOOL
    local equippedTool = LocalPlayer.Character:FindFirstChild(toolName)
    
    if not equippedTool and REMOTES.EquipItem then
        REMOTES.EquipItem:InvokeServer(toolName)
        equippedTool = LocalPlayer.Character:WaitForChild(toolName, 1.0)
        if not equippedTool then return false end
    end
    
    -- 5. TELEPORT AND CAMERA
    local offset = CONFIG.Combat.TeleportOffset
    local targetPos = targetPart.Position + offset
    hrp.CFrame = CFrame.new(targetPos)
    
    if Camera and targetPart and targetPart.Position then 
        if not _ORIGINAL_CAMERA_CFRAME then
            _ORIGINAL_CAMERA_CFRAME = Camera.CFrame 
        end
        
        local targetCFrame = CFrame.new(targetPart.Position)
        Camera.CFrame = CFrame.new(targetCFrame.p + (targetCFrame.LookVector * -5) + Vector3.new(0, 2, 0), targetCFrame.p)
    else
        restoreCamera() 
        return false
    end
    
    -- 6. SIMULATE ACTION
    simulateAction(toolName, targetRemoteInstance)

    return true
end

local function executeMiningAction(hrp)
    local toolName = _MINING_TOOL_NAME
    local targetNames = getTargetNames("Mining")
    
    if not isTargetValid(_CURRENT_TARGET_IDENTIFIER) then 
        _CURRENT_TARGET_IDENTIFIER = nil 
        _CURRENT_TARGET_PART = nil 
    end

    local newResourcePart, newResourceKey = findBestCombatTarget(hrp, targetNames) 

    if newResourcePart then
        if _CURRENT_TARGET_IDENTIFIER ~= newResourceKey then
            _CURRENT_TARGET_PART = newResourcePart 
            _CURRENT_TARGET_IDENTIFIER = newResourceKey 
            updateGUI()
        end
    else
        if _CURRENT_TARGET_IDENTIFIER then
            _CURRENT_TARGET_PART = nil
            _CURRENT_TARGET_IDENTIFIER = nil
            restoreCamera()
            updateGUI()
        end
        return false 
    end
    
    -- EQUIP TOOL
    local equippedTool = LocalPlayer.Character:FindFirstChild(toolName)
    
    if not equippedTool and REMOTES.EquipItem then
        REMOTES.EquipItem:InvokeServer(toolName)
        equippedTool = LocalPlayer.Character:WaitForChild(toolName, 1.0)
        if not equippedTool then return false end
    end
    
    -- TELEPORT AND CAMERA
    local resourcePart = _CURRENT_TARGET_PART 
    local resourceRemoteInstance = _CURRENT_TARGET_IDENTIFIER 
    
    if not isTargetValid(resourceRemoteInstance) or not resourcePart or not resourcePart:IsA("BasePart") then
         _CURRENT_TARGET_PART = nil
         _CURRENT_TARGET_IDENTIFIER = nil
         return false
    end
    
    local offset = CONFIG.Mining.TeleportOffset
    local resourcePos = resourcePart.Position + offset
    hrp.CFrame = CFrame.new(resourcePos)
    
    if Camera and resourcePart and resourcePart.Position then 
        if not _ORIGINAL_CAMERA_CFRAME then
            _ORIGINAL_CAMERA_CFRAME = Camera.CFrame 
        end

        local resourceCFrame = CFrame.new(resourcePart.Position)
        Camera.CFrame = CFrame.new(resourceCFrame.p + (resourceCFrame.LookVector * -5) + Vector3.new(0, 2, 0), resourceCFrame.p)
        
        -- SIMULATE ACTION
        simulateAction(toolName, resourceRemoteInstance)
    else
        restoreCamera() 
    end
    
    return true
end

-- [ 5. GUI FUNCTIONS (Modified to use global state) ]

local function setMinimizedState(isMinimized)
    _IS_MINIMIZED = isMinimized
    
    if not _MAIN_GUI or not _MAIN_GUI.MainFrame then return end

    local MainFrame = _MAIN_GUI.MainFrame
    local ContentContainer = MainFrame:FindFirstChild("ContentContainer")
    local TabBar = MainFrame:FindFirstChild("TabBar")
    
    if not ContentContainer or not TabBar or not _MAIN_GUI.MinimizeButton then return end
    
    ContentContainer.Visible = not isMinimized
    TabBar.Visible = not isMinimized
    
    if isMinimized then
        MainFrame:TweenSize(UDim2.new(0, CONFIG.FrameWidth, 0, CONFIG.TitleBarHeight), "Out", "Quad", 0.2, true)
        _MAIN_GUI.MinimizeButton.Text = "â–¡" 
    else
        MainFrame:TweenSize(UDim2.new(0, CONFIG.FrameWidth, 0, INITIAL_FRAME_HEIGHT), "Out", "Quad", 0.2, true)
        _MAIN_GUI.MinimizeButton.Text = "\u{2014}" 
    end
end

local function updateGUI()
    if not _MAIN_GUI then return end
    
    local toggleButton = _MAIN_GUI.GeneralPage.ToggleButton
    local modeButton = _MAIN_GUI.GeneralPage.ModeButton
    local ignoreButton = _MAIN_GUI.GeneralPage.IgnoreButton 
    local autoIgnoreButton = _MAIN_GUI.GeneralPage.AutoIgnoreButton 
    local safetyNetButton = _MAIN_GUI.GeneralPage.SafetyNetButton 
    
    if _ENABLED then
        toggleButton.Text = "ON"
        toggleButton.BackgroundColor3 = CONFIG.ToggleOnColor
    else
        toggleButton.Text = "OFF"
        toggleButton.BackgroundColor3 = CONFIG.ToggleOffColor
    end
    
    if _ENABLED then
        ignoreButton.Visible = true
        
        local identifier = _CURRENT_TARGET_IDENTIFIER
        if identifier then
            local targetName = identifier.Name
            ignoreButton.Text = string.format("IGNORE THIS: %s", targetName)
            ignoreButton.BackgroundColor3 = Color3.fromRGB(150, 0, 200) 
        else
            ignoreButton.Text = "No Target to Ignore"
            ignoreButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80) 
        end
    else
        ignoreButton.Visible = false
    end

    if _AUTO_IGNORE_ENABLED then
        autoIgnoreButton.Text = "10s Auto-Ignore: ON"
        autoIgnoreButton.BackgroundColor3 = CONFIG.ToggleOnColor
    else
        autoIgnoreButton.Text = "10s Auto-Ignore: OFF"
        autoIgnoreButton.BackgroundColor3 = CONFIG.ToggleOffColor
    end

    if _SAFETY_NET_ENABLED then
        safetyNetButton.Text = "TP Back on Death: ON"
        safetyNetButton.BackgroundColor3 = CONFIG.ToggleOnColor
    else
        safetyNetButton.Text = "TP Back on Death: OFF"
        safetyNetButton.BackgroundColor3 = CONFIG.ToggleOffColor
    end

    local currentToolName = (_MODE == "Combat") and _COMBAT_TOOL_NAME or _MINING_TOOL_NAME
    local modeDisplayName = (_MODE == "Combat") and "Attacking" or "Mining"
    modeButton.Text = modeDisplayName .. " ("..currentToolName..")"
    
    for tabName, tabButton in pairs(_MAIN_GUI.Tabs) do
        if tabName == _CURRENT_TAB then
            tabButton.BackgroundColor3 = CONFIG.BackgroundColor 
            tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        else
            tabButton.BackgroundColor3 = CONFIG.TabBarColor 
            tabButton.TextColor3 = Color3.fromRGB(150, 150, 150)
        end
    end
    
    if _MAIN_GUI.CombatPage.PriorityZoneLabel then
        local label = _MAIN_GUI.CombatPage.PriorityZoneLabel
        local button = _MAIN_GUI.CombatPage.SetPriorityZoneButton
        local zoneCount = #_PRIORITY_ZONES
        
        label.Text = string.format("Priority Zones: %d / 15", zoneCount)
        
        local isFull = (zoneCount >= 15)
        button.AutoButtonColor = not isFull 
        button.BackgroundColor3 = isFull and Color3.fromRGB(80, 80, 80) or CONFIG.AccentColor
        button.Text = isFull and "Priority Zones Full (15/15)" or "Set Priority Zone (at HRP)"
    end
end

local function showTab(tabName)
    _CURRENT_TAB = tabName
    updateGUI()
    
    local contentContainer = _MAIN_GUI.MainFrame:FindFirstChild("ContentContainer")
    if not contentContainer then return end

    for _, page in pairs(contentContainer:GetChildren()) do
        if page:IsA("Frame") and page.Name:match("Page$") then
            page.Visible = false
        end
    end
    
    if _MAIN_GUI.Pages[tabName] then
        _MAIN_GUI.Pages[tabName].Visible = true
    end
end

local function setupGUI()
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    if playerGui:FindFirstChild("MultiBotGui") then playerGui.MultiBotGui:Destroy() end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "MultiBotGui"
    ScreenGui.Parent = playerGui

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, CONFIG.FrameWidth, 0, INITIAL_FRAME_HEIGHT) 
    MainFrame.Position = _UI_POSITION 
    MainFrame.BackgroundColor3 = CONFIG.BackgroundColor
    MainFrame.BorderColor3 = Color3.fromRGB(15, 15, 20)
    MainFrame.BorderSizePixel = 1
    MainFrame.Parent = ScreenGui
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, CONFIG.MainFrameCornerRadius)
    
    local TitleBar = Instance.new("Frame")
    TitleBar.Name = "TitleBar"
    TitleBar.Size = UDim2.new(1, 0, 0, CONFIG.TitleBarHeight)
    TitleBar.BackgroundColor3 = CONFIG.TitleBarColor
    TitleBar.Parent = MainFrame
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Name = "TitleLabel"
    TitleLabel.Position = UDim2.new(0, 8, 0, 0)
    TitleLabel.Size = UDim2.new(1, -70, 1, 0) 
    TitleLabel.Text = "Studlands (V53 - Procedural)" 
    TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextSize = 18 
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Parent = TitleBar
    
    local controlSize = CONFIG.TitleBarHeight - 18 
    
    local function createControl(text, color, name, anchorX)
        local btn = Instance.new("TextButton")
        btn.Name = name
        btn.Size = UDim2.new(0, controlSize, 0, controlSize) 
        btn.Text = text
        btn.TextSize = 14 
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.BackgroundColor3 = color 
        btn.Parent = TitleBar
        btn.BorderSizePixel = 0
        btn.AnchorPoint = Vector2.new(anchorX, 0.5)
        btn.Position = UDim2.new(anchorX, 0, 0.5, 0)
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)
        return btn
    end

    local buttonSpacing = 5 
    local buttonSize = controlSize 

    local CloseButton = createControl("X", CONFIG.CloseButtonBaseColor, "CloseButton", 1)
    CloseButton.Position = UDim2.new(1, -buttonSpacing, 0.5, 0)
    
    local MinimizeButton = createControl("\u{2014}", CONFIG.MinimizeButtonBaseColor, "MinimizeButton", 1) 
    MinimizeButton.Position = UDim2.new(1, -(buttonSpacing + buttonSize + buttonSpacing), 0.5, 0)

    MinimizeButton.MouseEnter:Connect(function() MinimizeButton.BackgroundColor3 = CONFIG.MinimizeButtonHoverColor end)
    MinimizeButton.MouseLeave:Connect(function() MinimizeButton.BackgroundColor3 = CONFIG.MinimizeButtonBaseColor end)
    CloseButton.MouseEnter:Connect(function() CloseButton.BackgroundColor3 = CONFIG.CloseButtonHoverColor end)
    CloseButton.MouseLeave:Connect(function() CloseButton.BackgroundColor3 = CONFIG.CloseButtonBaseColor end)
    
    local dragging = false
    local dragStart = Vector2.new(0, 0)
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
        end
    end)
    TitleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePosition = UserInputService:GetMouseLocation() 
            MainFrame.Position = UDim2.fromOffset(
                mousePosition.X - dragStart.X,
                mousePosition.Y - dragStart.Y
            )
            _UI_POSITION = MainFrame.Position
        end
    end)
    
    local TabBar = Instance.new("Frame")
    TabBar.Position = UDim2.new(0, 0, 0, CONFIG.TitleBarHeight)
    TabBar.Size = UDim2.new(1, 0, 0, CONFIG.TabBarHeight)
    TabBar.BackgroundColor3 = CONFIG.TabBarColor 
    TabBar.Parent = MainFrame
    
    local TabLayout = Instance.new("UIListLayout")
    TabLayout.FillDirection = Enum.FillDirection.Horizontal
    TabLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    TabLayout.Parent = TabBar

    local TabNames = {"General", "Combat", "Mining"} 
    local Tabs = {}
    
    for _, tabName in ipairs(TabNames) do
        local tabButton = Instance.new("TextButton")
        tabButton.Name = tabName .. "Tab"
        tabButton.Size = UDim2.new(1/#TabNames, 0, 1, 0)
        tabButton.Text = tabName
        tabButton.Font = Enum.Font.Gotham
        tabButton.TextColor3 = Color3.fromRGB(150, 150, 150)
        tabButton.BackgroundColor3 = CONFIG.TabBarColor 
        tabButton.Parent = TabBar
        
        tabButton.MouseButton1Click:Connect(function()
            showTab(tabName)
        end)
        Tabs[tabName] = tabButton
    end
    
    local ContentContainer = Instance.new("Frame")
    ContentContainer.Name = "ContentContainer"
    ContentContainer.Position = UDim2.new(0, 0, 0, CONFIG.TitleBarHeight + CONFIG.TabBarHeight) 
    ContentContainer.Size = UDim2.new(1, 0, 1, -(CONFIG.TitleBarHeight + CONFIG.TabBarHeight))
    ContentContainer.BackgroundColor3 = CONFIG.BackgroundColor
    ContentContainer.Parent = MainFrame
    
    local function createContentPage(parent, name)
        local page = Instance.new("Frame")
        page.Name = name .. "Page"
        page.Size = UDim2.new(1, 0, 1, 0)
        page.BackgroundTransparency = 1 
        page.Visible = false
        page.Parent = parent
        
        local Padding = Instance.new("UIPadding", page)
        Padding.PaddingTop = UDim.new(0, 10)
        
        local ListLayout = Instance.new("UIListLayout", page)
        ListLayout.Padding = UDim.new(0, 8) 
        ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
        ListLayout.FillDirection = Enum.FillDirection.Vertical
        
        return page
    end

    local function createButton(parent, text, color, layoutOrder)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(0.9, 0, 0, CONFIG.ButtonHeight) 
        button.Text = text
        button.BackgroundColor3 = color or CONFIG.ToggleOffColor
        button.Font = Enum.Font.GothamBold
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Parent = parent
        button.BorderSizePixel = 0
        button.LayoutOrder = layoutOrder
        Instance.new("UICorner", button).CornerRadius = UDim.new(0, CONFIG.ButtonCornerRadius)
        return button
    end
    
    local function createInputLabel(parent, text, layoutOrder)
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 20)
        label.Text = text
        label.TextColor3 = Color3.fromRGB(200, 200, 200)
        label.Font = Enum.Font.Gotham
        label.TextSize = 14
        label.BackgroundTransparency = 1
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = parent
        label.LayoutOrder = layoutOrder
        return label
    end

    local function createTextBox(parent, initialText, placeholder, layoutOrder)
        local textBox = Instance.new("TextBox")
        textBox.Size = UDim2.new(0.9, 0, 0, CONFIG.InputHeight)
        textBox.Text = initialText
        textBox.PlaceholderText = placeholder or ""
        textBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
        textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
        textBox.BackgroundColor3 = CONFIG.InputBackgroundColor
        textBox.Font = Enum.Font.Gotham
        textBox.TextSize = 14
        textBox.Parent = parent
        textBox.BorderSizePixel = 0
        textBox.LayoutOrder = layoutOrder
        Instance.new("UICorner", textBox).CornerRadius = UDim.new(0, CONFIG.ButtonCornerRadius)
        return textBox
    end
    

    local Pages = {}
    local GeneralPage = createContentPage(ContentContainer, "General")
    
    local ToggleButton = createButton(GeneralPage, "OFF", CONFIG.ToggleOffColor, 1) 
    ToggleButton.Name = "ToggleButton"
    ToggleButton.MouseButton1Click:Connect(function()
        _ENABLED = not _ENABLED
        _CURRENT_TARGET_PART = nil 
        _CURRENT_TARGET_IDENTIFIER = nil 
        _CURRENT_ZONE_INDEX = 1 
        if not _ENABLED then restoreCamera() end
        updateGUI()
    end)

    local currentToolName = (_MODE == "Combat") and _COMBAT_TOOL_NAME or _MINING_TOOL_NAME
    local modeDisplayName = (_MODE == "Combat") and "Attacking" or "Mining"
    local ModeButton = createButton(GeneralPage, modeDisplayName .. " ("..currentToolName..")", CONFIG.AccentColor, 2)
    ModeButton.Name = "ModeButton"
    ModeButton.MouseButton1Click:Connect(function()
        _MODE = (_MODE == "Combat" and "Mining" or "Combat")
        _CURRENT_TARGET_PART = nil 
        _CURRENT_TARGET_IDENTIFIER = nil 
        _CURRENT_ZONE_INDEX = 1 
        restoreCamera()
        updateGUI()
    end)

    local IgnoreButton = createButton(GeneralPage, "No Target to Ignore", Color3.fromRGB(80, 80, 80), 3)
    IgnoreButton.Name = "IgnoreButton"
    IgnoreButton.Visible = false 
    IgnoreButton.MouseButton1Click:Connect(function()
        if _ENABLED and _CURRENT_TARGET_IDENTIFIER then 
            _IGNORED_TARGETS[_CURRENT_TARGET_IDENTIFIER] = true 
            _CURRENT_TARGET_PART = nil 
            _CURRENT_TARGET_IDENTIFIER = nil 
            _TARGET_ACQUIRED_TIME = nil 
            _CURRENT_ZONE_INDEX = 1 
            restoreCamera()
            updateGUI()
        end
    end)

    local ClearIgnoreButton = createButton(GeneralPage, "Clear Ignore List", Color3.fromRGB(220, 120, 0), 4) 
    ClearIgnoreButton.Name = "ClearIgnoreButton"
    ClearIgnoreButton.MouseButton1Click:Connect(function()
        _IGNORED_TARGETS = setmetatable({}, {__mode = "k"})
        if _CURRENT_TARGET_IDENTIFIER and _IGNORED_TARGETS[_CURRENT_TARGET_IDENTIFIER] then
            _CURRENT_TARGET_PART = nil
            _CURRENT_TARGET_IDENTIFIER = nil
            restoreCamera()
        end
        updateGUI()
    end)
    
    local AutoIgnoreButton = createButton(GeneralPage, "10s Auto-Ignore: ON", CONFIG.ToggleOnColor, 5)
    AutoIgnoreButton.Name = "AutoIgnoreButton"
    AutoIgnoreButton.MouseButton1Click:Connect(function()
        _AUTO_IGNORE_ENABLED = not _AUTO_IGNORE_ENABLED
        updateGUI()
    end)
    
    local SafetyNetButton = createButton(GeneralPage, "TP Back on Death: ON", CONFIG.ToggleOnColor, 6)
    SafetyNetButton.Name = "SafetyNetButton"
    SafetyNetButton.MouseButton1Click:Connect(function()
        _SAFETY_NET_ENABLED = not _SAFETY_NET_ENABLED
        updateGUI()
    end)


    Pages["General"] = GeneralPage
    
    local CombatPage = createContentPage(ContentContainer, "Combat")
    
    createInputLabel(CombatPage, "Attack Weapon/Tool Name:", 1)
    local CToolNameInput = createTextBox(CombatPage, _COMBAT_TOOL_NAME, "E.g., Clockwork Hammer", 2)
    CToolNameInput.Name = "CToolNameInput"
    CToolNameInput.FocusLost:Connect(function(enterPressed)
        _COMBAT_TOOL_NAME = CToolNameInput.Text
        _CURRENT_TARGET_PART = nil 
        _CURRENT_TARGET_IDENTIFIER = nil 
        updateGUI() 
    end)
    
    createInputLabel(CombatPage, "Target Names (comma-separated):", 3)
    local CTargetNamesInput = createTextBox(CombatPage, _COMBAT_TARGET_NAMES, "E.g., Cavey, Bonezos", 4)
    CTargetNamesInput.Name = "CTargetNamesInput"
    CTargetNamesInput.FocusLost:Connect(function(enterPressed)
        _COMBAT_TARGET_NAMES = CTargetNamesInput.Text
        _CURRENT_TARGET_PART = nil 
        _CURRENT_TARGET_IDENTIFIER = nil 
    end)
    
    local PriorityZoneLabel = Instance.new("TextLabel")
    PriorityZoneLabel.Name = "PriorityZoneLabel"
    PriorityZoneLabel.Size = UDim2.new(0.9, 0, 0, 20)
    PriorityZoneLabel.Text = string.format("Priority Zones: %d / 15", #_PRIORITY_ZONES)
    PriorityZoneLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    PriorityZoneLabel.Font = Enum.Font.Gotham
    PriorityZoneLabel.TextSize = 14
    PriorityZoneLabel.BackgroundTransparency = 1
    PriorityZoneLabel.TextXAlignment = Enum.TextXAlignment.Center
    PriorityZoneLabel.Parent = CombatPage
    PriorityZoneLabel.LayoutOrder = 5
    
    local SetPriorityZoneButton = createButton(CombatPage, "Set Priority Zone (at HRP)", CONFIG.AccentColor, 6)
    SetPriorityZoneButton.Name = "SetPriorityZoneButton"
    SetPriorityZoneButton.MouseButton1Click:Connect(function()
        if #_PRIORITY_ZONES < 15 then
            local hrp = getHumanoidRootPart()
            if hrp then
                table.insert(_PRIORITY_ZONES, hrp.Position)
                _CURRENT_ZONE_INDEX = 1 
                updateGUI()
            end
        end
    end)
    
    local ClearPriorityZonesButton = createButton(CombatPage, "Clear All Priority Zones", CONFIG.ToggleOffColor, 7)
    ClearPriorityZonesButton.Name = "ClearPriorityZonesButton"
    ClearPriorityZonesButton.MouseButton1Click:Connect(function()
        _PRIORITY_ZONES = {}
        _CURRENT_ZONE_INDEX = 1 
        updateGUI()
    end)


    Pages["Combat"] = CombatPage
    
    local MiningPage = createContentPage(ContentContainer, "Mining")
    
    createInputLabel(MiningPage, "Mining Tool Name:", 1)
    local MToolNameInput = createTextBox(MiningPage, _MINING_TOOL_NAME, "E.g., Eternium Pickaxe", 2)
    MToolNameInput.Name = "MToolNameInput"
    MToolNameInput.FocusLost:Connect(function(enterPressed)
        _MINING_TOOL_NAME = MToolNameInput.Text
        _CURRENT_TARGET_PART = nil 
        _CURRENT_TARGET_IDENTIFIER = nil 
        updateGUI()
    end)
    
    createInputLabel(MiningPage, "Resource Names (comma-separated):", 3)
    local MTargetNamesInput = createTextBox(MiningPage, _MINING_TARGET_NAMES, "E.g., Iron, Rock, Gold", 4)
    MTargetNamesInput.Name = "MTargetNamesInput"
    MTargetNamesInput.FocusLost:Connect(function(enterPressed)
        _MINING_TARGET_NAMES = MTargetNamesInput.Text
        _CURRENT_TARGET_PART = nil 
        _CURRENT_TARGET_IDENTIFIER = nil 
    end)
    
    _MAIN_GUI = {
        ScreenGui = ScreenGui,
        MainFrame = MainFrame,
        MinimizeButton = MinimizeButton,
        Tabs = Tabs,
        Pages = Pages,
        GeneralPage = { ToggleButton = ToggleButton, ModeButton = ModeButton, IgnoreButton = IgnoreButton, AutoIgnoreButton = AutoIgnoreButton, SafetyNetButton = SafetyNetButton, },
        CombatPage = { PriorityZoneLabel = PriorityZoneLabel, SetPriorityZoneButton = SetPriorityZoneButton, },
    }

    MinimizeButton.MouseButton1Click:Connect(function()
        setMinimizedState(not _IS_MINIMIZED)
    end)

    CloseButton.MouseButton1Click:Connect(function()
        if _LOOP_THREAD then task.cancel(_LOOP_THREAD) end
        restoreCamera()
        ScreenGui:Destroy()
    end)
    
    setMinimizedState(_IS_MINIMIZED)
    showTab(_CURRENT_TAB)
end

-- [ 6. INITIALIZATION AND LISTENERS ]

local function initialize()
    getRemotes()
    setupGUI()
    
    -- CharacterAdded Listener (Simplified)
    LocalPlayer.CharacterAdded:Connect(function(character)
        task.wait(0.5) 
        _CURRENT_TARGET_PART = nil
        _CURRENT_TARGET_IDENTIFIER = nil 
        _TARGET_ACQUIRED_TIME = nil 
        _CURRENT_ZONE_INDEX = 1 
        
        -- SafetyNet Teleport
        if _SAFETY_NET_ENABLED and _LAST_DEATH_CFRAME then
            local newHrp = character:WaitForChild("HumanoidRootPart", 5)
            if newHrp then
                newHrp.CFrame = _LAST_DEATH_CFRAME
            end
            _LAST_DEATH_CFRAME = nil 
        end

        -- Add 'Died' listener to the new character's humanoid
        local humanoid = character:WaitForChild("Humanoid")
        humanoid.Died:Connect(function()
            if character and character:FindFirstChild("HumanoidRootPart") then
                _LAST_DEATH_CFRAME = character.HumanoidRootPart.CFrame
            end
        end)
        
        if not LocalPlayer:WaitForChild("PlayerGui", 5):FindFirstChild("MultiBotGui") then
            setupGUI()
            updateGUI() 
        end
    end)
    
    -- Initial 'Died' listener
    if LocalPlayer.Character then
        local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
             humanoid.Died:Connect(function()
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    _LAST_DEATH_CFRAME = LocalPlayer.Character.HumanoidRootPart.CFrame
                end
            end)
        end
    end

    -- Main Farm Loop (Directly spawned)
    _LOOP_THREAD = task.spawn(function()
        while task.wait(CONFIG.FarmSpeed) do
            if _ENABLED then
                local hrp = getHumanoidRootPart()
                
                if not hrp then continue end
                
                if _MODE == "Combat" then
                    executeCombatAction(hrp)
                elseif _MODE == "Mining" then
                    executeMiningAction(hrp)
                end
            end
        end
    end)
end

-- [ 7. EXECUTION ]
-- Run initialization directly without any wrappers or pcalls, which should be 
-- the fastest and simplest way to load the script bytes.
initialize()
