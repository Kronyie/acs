-- ... existing code ...
-- CONFIGURATION

local CONFIG = {
    ScriptName = "Studlands (V47)", 
    DefaultMode = "Combat", 
    FarmSpeed = 0.25, -- EDITED: Was 0.05 (20x/sec). Changed to 0.25 (4x/sec) to reduce lag.
-- ... existing code ...
function MultiGrinder:executePriorityAreaCombat(hrp)
-- ... existing code ...
    -- We're already at the area CFrame, but we update LastKnownPosition
    -- in case we die *while* at the mob.
    self.LastKnownPosition = hrp.Position 
    
    hrp.CFrame = CFrame.new(targetPos)
    -- End of V46 change
    
    local char = LocalPlayer.Character
-- ... existing code ...
        if equippedTool then
            print(string.format("[Multi-Bot Debug] Equip SUCCESS: %s located in character.", toolName))
            self.EquippedToolName = toolName 
        else
            warn(string.format("[Multi-Bot Debug] Equip FAILED: %s did not appear in character after 1s.", toolName))
            self.EquippedToolName = nil 
            return false 
        end
    end
    
    -- V47 FIX: REMOVED DUPLICATE TELEPORT BLOCK
    -- local offset = CONFIG.Combat.TeleportOffset
    -- local targetPos = target.Position + offset
    -- self.LastKnownPosition = hrp.Position
    -- hrp.CFrame = CFrame.new(targetPos)
    
    if Camera and target and target.Position then 
        if not self.OriginalCameraCFrame then
-- ... existing code ...
    end

    return true
end

-- V47 FIX: ADDING BACK THE MISSING executeCombatAction FUNCTION
function MultiGrinder:executeCombatAction(hrp)
    -- NEW (V45): Priority Area logic branch
    if self.PriorityAreaEnabled and #self.PriorityAreas > 0 then
        return self:executePriorityAreaCombat(hrp)
    end
    
    -- V45: This is now the "else" branch (original logic)
    -- Reset priority area state just in case
    if self.PriorityAreaTarget or self.PriorityAreaScanTimer > 0 then
        self.PriorityAreaTarget = nil
        self.PriorityAreaScanTimer = 0
        self.CurrentPriorityAreaIndex = 1
    end

    local toolName = self.CombatToolName
    local remotes = self.Remotes
    local target = self.CurrentTarget
    
    -- Check if the mob model is gone or dead.
    local needsNewTarget = not target or not target.Parent or not target.Parent:FindFirstChildOfClass("Humanoid") or target.Parent:FindFirstChildOfClass("Humanoid").Health <= 0
    
    if needsNewTarget then
        local targetNames = self:getTargetNames("Combat")
        
        -- V41 CHANGE: Receive both values
        local newTarget, newTargetKey = self:findClosestTarget(hrp.Position, targetNames)
        
        if not newTarget then 
            self.CurrentTarget = nil 
            self.CurrentTargetIdentifier = nil -- V40
            self.TargetAcquiredTime = nil 
            restoreCamera(self) 
            self:updateGUI() 
            return false 
        end
        
        self.CurrentTarget = newTarget
        self.CurrentTargetIdentifier = newTargetKey -- V41: Store the Model/Key
        target = self.CurrentTarget
        self.TargetAcquiredTime = os.clock() 
        self:updateGUI() 
    end
    
    -- V38/V42: Auto-ignore target if alive for too long
    if self.AutoIgnoreEnabled and target and self.TargetAcquiredTime and (os.clock() - self.TargetAcquiredTime > 10) then
        local humanoid = target.Parent:FindFirstChildOfClass("Humanoid")
        if humanoid and humanoid.Health > 0 then
            local targetName = target.Parent and target.Parent.Name or target.Name
            print(string.format("[Multi-Bot Debug] Target %s alive for > 10s. Auto-ignoring.", targetName))
            
            -- V40 FIX: Use the CurrentTargetIdentifier for ignoring
            if self.CurrentTargetIdentifier then
                self.IgnoredTargets[self.CurrentTargetIdentifier] = true 
            end
            
            self.CurrentTarget = nil 
            self.CurrentTargetIdentifier = nil -- V40
            self.TargetAcquiredTime = nil
            restoreCamera(self)
            self:updateGUI()
            return false 
        else
            self.TargetAcquiredTime = nil
        end
    end
    
    local char = LocalPlayer.Character
    if not char then return false end
    
    local equippedTool = char:FindFirstChild(toolName)
    
    if not equippedTool and remotes.EquipItem then
        print(string.format("[Multi-Bot Debug] Equipping tool: %s", toolName))
        remotes.EquipItem:InvokeServer(toolName)
        
        equippedTool = char:WaitForChild(toolName, 1.0)
        
        if equippedTool then
            print(string.format("[Multi-Bot Debug] Equip SUCCESS: %s located in character.", toolName))
            self.EquippedToolName = toolName 
        else
            warn(string.format("[Multi-Bot Debug] Equip FAILED: %s did not appear in character after 1s.", toolName))
            self.EquippedToolName = nil 
            return false 
        end
    end
    
    local offset = CONFIG.Combat.TeleportOffset
    local targetPos = target.Position + offset
    
    -- V44: Store last position before teleporting
    self.LastKnownPosition = hrp.Position
    
    hrp.CFrame = CFrame.new(targetPos)
    
    if Camera and target and target.Position then 
        if not self.OriginalCameraCFrame then
            self.OriginalCameraCFrame = Camera.CFrame 
        end
        
        local targetCFrame = CFrame.new(target.Position)
        Camera.CFrame = CFrame.new(targetCFrame.p + (targetCFrame.LookVector * -5) + Vector3.new(0, 2, 0), targetCFrame.p)

        self:simulateAction(toolName)
    else
        warn("[Multi-Bot Debug] Target or Camera was invalid during attack sequence.")
        restoreCamera(self) 
    end

    return true
end
-- END OF NEWLY ADDED FUNCTION

function MultiGrinder:executeMiningAction(hrp)
    local toolName = self.MiningToolName
-- ... existing code ...
